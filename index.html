<!DOCTYPE html>
<html>
<head>
    <title>Peru Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        .container { display: flex; }
        #map { height: 400px; width: 50%; }
        #chart { width: 50%; }
    </style>
</head>
<body>
    <select id="regionSelect"></select>
    <div class="container">
        <div id="map"></div>
        <canvas id="chart"></canvas>
    </div>
    <script>
        let chart, map, geojsonLayer;
        
        // Initialize map
        map = L.map('map').setView([-9.189967, -75.015152], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        // Load GeoJSON and data
        Promise.all([
            fetch('input.csv').then(r => r.text()),
            fetch('peru_regions.geojson').then(r => r.json())
        ]).then(([csvText, geojson]) => {
            const data = Papa.parse(csvText, {
                header: true,
                dynamicTyping: true
            }).data;
            
            geojsonLayer = L.geoJSON(geojson, {
                style: feature => ({
                    fillColor: '#ccc',
                    weight: 1,
                    opacity: 1,
                    color: 'white',
                    fillOpacity: 0.7
                })
            }).addTo(map);
            
            createVisualization(data, geojson);
        });

        function createVisualization(data, geojson) {
            // ... [previous chart code] ...

            function updateVisuals(region) {
                // Update chart
                const filteredData = data.filter(d => d.department == region);
                chart.data = {
                    labels: filteredData.map(d => d.year),
                    datasets: [{
                        label: 'Region ' + region,
                        data: filteredData.map(d => d.y_HH),
                        borderColor: '#4e79a7',
                        backgroundColor: '#4e79a7',
                        pointRadius: 3,
                        pointHoverRadius: 7,
                        pointBackgroundColor: '#4e79a7'
                    }]
                };
                chart.update('none');

                // Update map
                geojsonLayer.setStyle(feature => ({
                    fillColor: feature.properties.region_id == region ? '#4e79a7' : '#ccc',
                    weight: 1,
                    opacity: 1,
                    color: 'white',
                    fillOpacity: 0.7
                }));
            }

            select.onchange = (e) => updateVisuals(e.target.value);
            updateVisuals(regions[0]);
        }
    </script>
</body>
</html>
