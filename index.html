<!DOCTYPE html>
<html>
<head>
   <title>Peru Dashboard</title>
   <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
   <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0"></script>
   <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
   <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
   <style>
       body { background: #f5f5f5; padding: 20px; }
       .container { display: flex; gap: 20px; margin-top: 20px; }
       #map { height: 400px; width: 40%; background: white; border-radius: 4px; }
       #chart { width: 60%; background: white; border-radius: 4px; padding: 20px; }
   </style>
</head>
<body>
   <select id="regionSelect" style="margin-bottom: 20px; padding: 5px;"></select>
   <div class="container">
       <div id="map"></div>
       <canvas id="chart"></canvas>
   </div>
   <script>
       let chart;
       let map = L.map('map', {
           zoomControl: false,
           dragging: false,
           touchZoom: false,
           scrollWheelZoom: false,
           doubleClickZoom: false
       }).setView([-9.189967, -75.015152], 5);

       // Load data and initialize visualizations
       Promise.all([
           fetch('/pilot2025-datasharing/input.csv').then(r => r.text()),
           fetch('/pilot2025-datasharing/peru_regions.geojson').then(r => r.json())
       ]).then(([csvText, geojson]) => {
           const data = Papa.parse(csvText, {
               header: true,
               dynamicTyping: true
           }).data;

           const geojsonLayer = L.geoJSON(geojson, {
               style: {
                   fillColor: '#ccc',
                   weight: 1,
                   opacity: 1,
                   color: 'white',
                   fillOpacity: 0.7
               }
           }).addTo(map);

           createVisualization(data, geojson, geojsonLayer);
       });

       function createVisualization(data, geojson, geojsonLayer) {
           const regions = [...new Set(data.map(d => d.department))];
           const select = document.getElementById('regionSelect');
           regions.forEach(region => {
               const option = document.createElement('option');
               option.value = region;
               option.text = region;
               select.appendChild(option);
           });

           const ctx = document.getElementById('chart').getContext('2d');
           chart = new Chart(ctx, {
               type: 'line',
               options: {
                   animation: false,
                   responsive: true,
                   interaction: {
                       intersect: false,
                       mode: 'index'
                   },
                   plugins: {
                       tooltip: {
                           backgroundColor: 'rgba(255, 255, 255, 0.9)',
                           titleColor: '#000',
                           bodyColor: '#000',
                           borderColor: '#ddd',
                           borderWidth: 1,
                           padding: 10,
                           displayColors: false,
                           callbacks: {
                               label: function(context) {
                                   return `Value: ${context.parsed.y.toFixed(2)}`;
                               },
                               title: function(context) {
                                   return `Year: ${context[0].label}`;
                               }
                           }
                       }
                   },
                   scales: {
                       x: {
                           grid: {
                               color: '#e5e5e5'
                           }
                       },
                       y: {
                           grid: {
                               color: '#e5e5e5'
                           }
                       }
                   }
               }
           });

           function updateVisuals(region) {
               const filteredData = data.filter(d => d.department == region);
               chart.data = {
                   labels: filteredData.map(d => d.year),
                   datasets: [{
                       label: 'Region ' + region,
                       data: filteredData.map(d => d.y_HH),
                       borderColor: '#4e79a7',
                       backgroundColor: '#4e79a7',
                       pointRadius: 3,
                       pointHoverRadius: 7,
                       pointBackgroundColor: '#4e79a7'
                   }]
               };
               chart.update('none');

               geojsonLayer.setStyle(feature => ({
                   fillColor: feature.properties.region_id == region ? '#4e79a7' : '#ccc',
                   weight: 1,
                   opacity: 1,
                   color: 'white',
                   fillOpacity: 0.7
               }));
           }

           select.onchange = (e) => updateVisuals(e.target.value);
           updateVisuals(regions[0]);
       }
   </script>
   <script>
    let map = L.map('map').setView([-9.189967, -75.015152], 5);
    
    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    Promise.all([
        fetch('input.csv')
            .then(r => r.text())
            .catch(e => {
                console.error('CSV error:', e);
                return null;
            }),
        fetch('peru_regions.geojson')
            .then(r => r.json())
            .catch(e => {
                console.error('GeoJSON error:', e);
                return null;
            })
    ]).then(([csvText, geojson]) => {
        if (!csvText || !geojson) {
            console.error('Failed to load data');
            return;
        }
        // Rest of your visualization code
    });
</script>
</body>
</html>
