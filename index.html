<!DOCTYPE html>
<html>
<head>
  <title>Time Series Debug</title>
  <!-- Chart.js from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- PapaParse from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0"></script>
  <style>
    body { background: #f5f5f5; margin: 0; padding: 20px; font-family: sans-serif; }
    #status { margin-bottom: 10px; font-weight: bold; }
    #chartContainer { background: #fff; border-radius: 4px; padding: 20px; max-width: 900px; margin: auto; }
    canvas { width: 100%; max-height: 400px; }
  </style>
</head>
<body>
  <div id="status">Loading...</div>
  <div id="chartContainer">
    <canvas id="myChart"></canvas>
  </div>

  <script>
    // 1) Attempt to load input.csv
    fetch('input.csv')
      .then(resp => {
        if (!resp.ok) throw new Error(`Failed to fetch input.csv (HTTP ${resp.status}). Possibly a 404 or path error.`);
        return resp.text();
      })
      .then(csvText => {
        // 2) Parse with Papa
        const parsed = Papa.parse(csvText, {
          header: true,
          dynamicTyping: true
        });
        if (parsed.errors.length > 0) {
          console.error('PapaParse Errors:', parsed.errors);
          document.getElementById('status').textContent = 'CSV parse error, check console.';
          return;
        }
        // All rows
        const data = parsed.data;
        console.log('Entire CSV data:', data);
        document.getElementById('status').textContent = 'CSV loaded successfully.';

        // 3) Create chart
        createTimeSeries(data);
      })
      .catch(err => {
        console.error('Fetch or parse error:', err);
        document.getElementById('status').textContent = 'Error: ' + err.message;
      });

    function createTimeSeries(allRows) {
      // 4) Filter for a region. If your CSV has "department=1" rows, do:
      const selectedRegion = 1; // or pick any region you know should exist
      const filtered = allRows.filter(row => row.department === selectedRegion);
      console.log(`Filtering for department=${selectedRegion}, found ${filtered.length} rows.`, filtered);

      let labels, values;
      if (filtered.length > 0) {
        labels = filtered.map(r => r.year);
        values = filtered.map(r => r.y_HH);
        document.getElementById('status').textContent += ` Showing region ${selectedRegion} with ${filtered.length} rows.`;
      } else {
        // fallback demo
        console.warn('No matching data found, using fallback sample data.');
        document.getElementById('status').textContent += ' No matching data, using fallback.';
        labels = [1997, 1998, 1999, 2000];
        values = [50, 100, 150, 200];
      }

      const ctx = document.getElementById('myChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Ingresos del Hogar Mensuales p/c (PEN)',
            data: values,
            borderColor: '#4e79a7',
            backgroundColor: '#4e79a7',
            pointRadius: 4,
            pointHoverRadius: 7
          }]
        },
        options: {
          responsive: true,
          interaction: { intersect: false, mode: 'index' },
          scales: {
            x: { display: true },
            y: { display: true }
          }
        }
      });
    }
  </script>
</body>
</html>
