<!DOCTYPE html>
<html>
<head>
   <title>Peru Time Series</title>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
   <style>
       body { padding: 20px; }
       .container { width: 80%; margin: 0 auto; }
       h1 { text-align: center; font-size: 2.5em; margin-bottom: 30px; color: #333; }
       select { padding: 5px; margin-bottom: 20px; }
   </style>
</head>
<body>
   <h1>Household Income Over Time</h1>
   <select id="regionSelect"></select>
   <div class="container">
       <canvas id="chart"></canvas>
   </div>
   <script>
       let chart;
       
       fetch('input.csv')
           .then(r => r.text())
           .then(csvText => {
               const data = Papa.parse(csvText, {
                   header: true,
                   dynamicTyping: true,
                   skipEmptyLines: true
               }).data;

               console.log('Data sample:', data.slice(0, 5)); // Debug log

               const regions = [...new Set(data
                   .filter(d => d && d.department && d.year && d.y_HH)
                   .map(d => d.department))]
                   .sort();

               console.log('Available regions:', regions); // Debug log

               const select = document.getElementById('regionSelect');
               regions.forEach(region => {
                   const option = document.createElement('option');
                   option.value = region;
                   option.text = region;
                   select.appendChild(option);
               });

               const ctx = document.getElementById('chart');
               chart = new Chart(ctx, {
                   type: 'line',
                   options: {
                       responsive: true,
                       interaction: {
                           intersect: false,
                           mode: 'index'
                       },
                       plugins: {
                           tooltip: {
                               backgroundColor: 'rgba(255, 255, 255, 0.9)',
                               titleColor: '#000',
                               bodyColor: '#000',
                               borderColor: '#ddd',
                               borderWidth: 1,
                               padding: 10,
                               displayColors: false,
                               callbacks: {
                                   label: function(context) {
                                       return `Income: ${context.parsed.y.toFixed(2)} PEN`;
                                   }
                               }
                           }
                       },
                       scales: {
                           y: {
                               title: {
                                   display: true,
                                   text: 'Monthly PEN p/c'
                               }
                           }
                       }
                   }
               });

               function updateChart(region) {
                   const filteredData = data
                       .filter(d => d && d.department === region && d.year && d.y_HH)
                       .sort((a, b) => a.year - b.year);

                   console.log('Filtered data for', region, ':', filteredData); // Debug log

                   chart.data = {
                       labels: filteredData.map(d => d.year),
                       datasets: [{
                           label: region,
                           data: filteredData.map(d => d.y_HH),
                           borderColor: '#4e79a7'
                       }]
                   };
                   chart.update();
               }

               select.onchange = (e) => updateChart(e.target.value);
               if (regions.length > 0) {
                   updateChart(regions[0]);
               }
           })
           .catch(error => console.error('Error loading data:', error));
   </script>
</body>
</html>
