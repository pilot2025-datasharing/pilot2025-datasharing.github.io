<!DOCTYPE html>
<html>
<head>
  <title>Peru Dashboard</title>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0"></script>
  <!-- Leaflet (no base map, just the library) -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    body { background: #f5f5f5; margin: 0; padding: 20px; font-family: sans-serif; }
    select { margin-bottom: 10px; padding: 5px; }
    .container { display: flex; gap: 20px; }
    #map {
      width: 40%;
      height: 500px;
      background: #fff; /* You can pick any color, this is your "blank" background. */
      border-radius: 4px;
    }
    #chartContainer {
      width: 60%;
      background: #fff;
      border-radius: 4px;
      padding: 20px;
    }
  </style>
</head>
<body>
  <select id="regionSelect"></select>
  <div class="container">
    <div id="map"></div>
    <div id="chartContainer">
      <canvas id="chart"></canvas>
    </div>
  </div>

  <script>
    let chart;
    let geojsonLayer;

    // 1) Initialize the Leaflet map with normal interactions (panning, zoom)
    let map = L.map('map', {
      zoomControl: true,   // allow zoom controls
      dragging: true,      // allow dragging
      scrollWheelZoom: true,
      doubleClickZoom: true,
      touchZoom: true
    }).setView([-9.189967, -75.015152], 5);

    // 2) Load data: input.csv (time series) & peru_regions.geojson (GeoJSON shapes)
    Promise.all([
      fetch('input.csv').then(r => r.text()),
      fetch('peru_regions.geojson').then(r => r.json())
    ]).then(([csvText, geojsonData]) => {
      // Parse CSV
      const data = Papa.parse(csvText, {
        header: true,
        dynamicTyping: true
      }).data;

      // Add the GeoJSON layer (blank background, only shapes)
      geojsonLayer = L.geoJSON(geojsonData, {
        style: {
          fillColor: '#cccccc',
          color: '#999', 
          weight: 1
        }
      }).addTo(map);

      // Adjust map bounds to fit all shapes
      map.fitBounds(geojsonLayer.getBounds());

      createVisualization(data);
    });

    function createVisualization(data) {
      // 3) Build region dropdown from CSV
      const regions = [...new Set(data.map(d => d.department))];
      const select = document.getElementById('regionSelect');
      regions.forEach(region => {
        const option = document.createElement('option');
        option.value = region;
        option.text = region;
        select.appendChild(option);
      });

      // 4) Setup Chart.js
      const ctx = document.getElementById('chart').getContext('2d');
      chart = new Chart(ctx, {
        type: 'line',
        options: {
          animation: false,
          responsive: true,
          interaction: { intersect: false, mode: 'index' }
        }
      });

      select.onchange = e => updateAll(e.target.value);
      updateAll(regions[0]); // initial selection
       
      function updateAll(region) {
        // Filter CSV data by region
        const filtered = data.filter(d => d.department == region);

        // Update chart data
        chart.data = {
          labels: filtered.map(d => d.year),
          datasets: [{
            label: `Region ${region}`,
            data: filtered.map(d => d.y_HH),
            borderColor: '#4e79a7',
            backgroundColor: '#4e79a7',
            pointRadius: 3,
            pointHoverRadius: 7
          }]
        };
        chart.update('none');

        // Update GeoJSON styling to highlight selected region
        // Assume your geojson has "region_id" or similar property matching CSV "department"
        geojsonLayer.setStyle(feature => {
          return {
            fillColor: (feature.properties.region_id == region) ? '#4e79a7' : '#cccccc',
            color: '#999', 
            weight: 1
          };
        });
      }
    }
  </script>
</body>
</html>
